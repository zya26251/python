#  第二周#

##注意要点##
1、代码规范  code -》reformat code  
2、request的时候判断状态码  
3、try,except 异常处理  
4、判断标签是否存在  
5、文件名命名规范。入口文件名最好为main.py  
6、在这条下运行
<pre><code>if \_\_name\_\_== '\_\_main\_\_'</code></pre>  
7、使用该方法去除多余空格  **.join('\n\t\t 12:32'.split())  
8、'全新'.find('新')  
'全新'[:pos]


#  第三周#

## 第二节课程 ：开始做简单的数据图表##

- **数据库中前300条记录**

 <pre><code>for i in item_info.find().limit(300):
	print(i['area']) #打印key为area的内容</code></pre>

- **punctuation的使用: 需要from string import punctuation** 
<pre><code>for i in item_info.find():
    if i['area']:
        area = [i for i in i['area'] if i not in punctuation] #如果i不在标点中，即为None的时候
    else:
        area = ['不明']
    item_info.update({'_id':i['_id']},{'$set':{'area':area}})</code>
</pre>

- **更新数据库 db.collection.update()** 

    db:数据库  
    collection:表  
	**update**(哪一个标识,改哪怎么改)：update({id:1},{$set{name:2}}) 把id为1的一行中的name改成2  
	$set{}:操作符

 	![](http://a3.qpic.cn/psb?/V10dzLRe48aRgF/rhDAUgTMY2uEBzLFfrfeewsNtoU5kosXjd2Ybq3eh*s!/b/dHABAAAAAAAA&bo=2wDCAQAAAAADBzo!&rf=viewer_4)

	**重要：在更新数据库前需要备份**
	
	![](http://a3.qpic.cn/psb?/V10dzLRe48aRgF/2StBsk9b2FB1PIVZIEq4MmhJBuEhHYoacmsu5EFZooY!/b/dHABAAAAAAAA&bo=1QKoAQAAAAABAFk!&rf=viewer_4)

<pre><code>
for i in item_info.find():
    if i['area']:
        area = [i for i in i['area'] if i not in punctuation]
    else:
        area = ['不明']
    item_info.update({'_id':i['_id']},{'$set':{'area':area}})</code></pre>
- **数据可视化** import charts
	 
格式：
<pre><code> data = {
     'name':area, #展示的可视化每一列的名称
     'data':[times], #数据,必须要列表的括号[]
     'type':types #图的类型
            }</code></pre>
去重的方法：
<pre><code>area_list = []
for i in item_info.find():
    area_list.append(i['area'][0])
area_index = list(set(area_list)) #去除重复，把集合转化成列表，set:集合，是没有重复的
print(area_index)</code></pre>
得出次数：
 <pre><code>post_times = []
for index in area_index:
    post_times.append(area_list.count(index))#将次数装入列表中
print(post_times)</code></pre>

形成图：
<pre><code>def data_gen(types):
    length = 0
    if length <= len(area_index):
        for area,times in zip(area_index,post_times):
            data = {
                'name':area,
                'data':[times],
                'type':types
            }
            yield data
            length += 1
data_gen('column')
for i in data_gen('column'):
    print(i) #打印生成器中所有的元素
series = [data for data in data_gen('column')]
charts.plot(series, show='inline', options=dict(title=dict(text='七日内北京城区二手物品发帖量')))</code></pre>

**小贴士：**  
[1、python yield 生成器的相关知识](http://www.ibm.com/developerworks/cn/opensource/os-cn-python-yield/index.html)  
        [2、mongodb基本操作](https://github.com/qianjiahao/MongoDB/wiki/MongoDB%E4%B9%8B%E7%B4%A2%E5%BC%95)
## 第三节课程 ：使用find函数精确查找数据## 

- **find()函数**  
	**find(?,):find({id:1},{name:1,info:1}** 并不会修改到数据库
	
	id:1中的'1'是id的值为1  
	name:1中的“1”代表布尔中的true,不是name值等于1。如果不想显示某个字段，则后面设为‘0’
<pre><code>
for in in item_info.find({},{'area':{$slice:1},'_id':0,'price':0}).limit(300)
# $slice：1 分片并取第一个。如果有对某个字段特殊处理，有不想要显示的字段，都要置0，如果没有特殊处理，则不需要
</code></pre>

<pre><code>for i in item_info.find({'pub_date':'2016.01.12'},{'area':{$slice:1},'_id':0,'price':0}).limit(300)
#显示pub_date为'2016.01.12'的行
for i in item_info.find({'pub_date':{$in:['2016.01.12','2016.01.14']}},{'area':{$slice:1},'_id':0,'price':0}).limit(300)
#显示pub_date为'2016.01.12'和'2016.01.14'的行，用$in操作符</code></pre>

**涉及的代码：**  
将2016-01-12变成2016.01.12
<pre><code>for i in item_info.find():
    frags = i['pub_date'].split('-')
    if len(frags) == 1:
        date = frags[0]#显示为2016.01.12的日期
    else:
        date = '{}.{}.{}'.format(frags[0],frags[1],frags[2])
    item_info.update_one({'_id':i['_id']},{'$set':{'pub_date':date}})</code></pre>
**datetime**:
<pre><code>from datetime import timedelta,date
a = date(2015,5,10)
print(a)#显示：2015-05-10
d = timedelta(days=1)
print(d) # 显示：1 day, 0:00:00
def get_all_dates(date1,date2):
    the_date = date(int(date1.split('.')[0]),int(date1.split('.')[1]),int(date1.split('.')[2]))
    end_date = date(int(date2.split('.')[0]),int(date2.split('.')[1]),int(date2.split('.')[2]))
    days = timedelta(days=1)

    while the_date <= end_date:
        yield (the_date.strftime('%Y.%m.%d'))#按格式返回
        the_date = the_date + days#每运行一次，加1天
for i in get_all_dates('2015.12.24','2016.01.05'):
    print(i)#打印从2015.12.24到2016.01.05每天的日期
def get_data_within(date1,date2,areas):
    for area in areas:
        area_day_posts = []
        for date in get_all_dates(date1,date2):
            a = list(item_info.find({'pub_date':date,'area':area}))
            each_day_post = len(a)
            area_day_posts.append(each_day_post)
        data = {
            'name': area,
            'data': area_day_posts,
            'type': 'line'
        }
        yield data

for i in get_data_within('2015.12.24','2016.01.05',['朝阳','海淀','通州']):
    print(i)
#options用法
options = {
    'chart'   : {'zoomType':'xy'},
    'title'   : {'text': '发帖量统计'},
    'subtitle': {'text': '可视化统计图表'},
    'xAxis'   : {'categories': [i for i in get_all_dates('2015.12.24','2016.01.05')]},#X轴
    'yAxis'   : {'title': {'text': '数量'}}#Y轴
    }

series = [i for i in get_data_within('2015.12.24','2016.01.05',['朝阳','海淀','通州'])]

charts.plot(series, options=options,show='inline')
# options=dict(title=dict(text='Charts are AWESOME!!!'))</code></pre>

## 第四节课程 ：使用聚合管道高效查找数据##
- **collection.aggregate(pipeline)**  
pipeline:管道模型  ![](http://a1.qpic.cn/psb?/V10dzLRe48aRgF/DhB9Muolc9Rg1qhwNzx5O2jye7gqGpZJw1BZ6H0afpU!/b/dIwBAAAAAAAA&bo=KAPnAQAAAAADB.8!&rf=viewer_4)  
![](http://a1.qpic.cn/psb?/V10dzLRe48aRgF/.Acv4pzAHTrJPsxKTmkW49RpvZRfhfLjH6pB.EFXy30!/b/dOQAAAAAAAAA&bo=MwPTAQAAAAADB8A!&rf=viewer_4)

事例：
<pre><code>
pipeline = [
    {'$match':{'$and':[{'pub_date':'2015.12.24'},{'time':3}]}},#$and：[]：且关系
    {'$group':{'_id':'$price','counts':{'$sum':1}}},#按照price分组，price相同的+1，就是统计相同price的次数。price前的$和and前的$不一样
    {'$sort' :{'counts':-1}},#1是顺序排，-1是倒序排
    {'$limit':3}#出现频率最高的3个价格
]
# {'pub_date':'2015.12.24'}
for i in item_info.aggregate(pipeline):
    print(i)

pipeline2 = [
    {'$match':{'$and':[{'pub_date':'2015.12.25'},{'time':3}]}},
    {'$group':{'_id':{'$slice':['$cates',2,1]},'counts':{'$sum':1}}},#跳过两个，选1个
    {'$sort':{'counts':-1}}
]
#定义成一个函数
def data_gen(date,time):
    pipeline = [
    {'$match':{'$and':[{'pub_date':date},{'time':time}]}},
    {'$group':{'_id':{'$slice':['$cates',2,1]},'counts':{'$sum':1}}},
    {'$sort':{'counts':-1}}
]
    for i in item_info.aggregate(pipeline):
        yield [i['_id'][0],i['counts']]

options = {
    'chart'   : {'zoomType':'xy'},
    'title'   : {'text': '发帖量统计'},
    'subtitle': {'text': '2016.01.10二手物品在随后7天内，交易时长为1天的类目分布占比'},
    }


series =  [{
    'type': 'pie',#饼图
    'name': 'pie charts',
    'data':[i for i in data_gen('2016.01.10',1)]

        }]
charts.plot(series,options=options,show='inline')
</code></pre>

## 第三周作业心得 ：##

1、 $and用于多条件 ，条件用{}括起来：'$and':[{},{}]  
2、 $nin : not in 的意思 
<pre><code>def data_gen2(date1,date2,cates):
    pipeline2 = [
        {'$match':{'$and':[{'date':{'$gte':date1,'$lte':date2}},
                           {'cate':{'$all':cates}},
                           {'old':{'$nin':['-']}}
                          ]}},
        {'$group': {'_id': '$old', 'avg_price': {'$avg': '$price'}}},
        {'$sort':{'avg_price':1}}
    ]
    for i in item_infoY.aggregate(pipeline2):
        yield i['_id'],i['avg_price']</code></pre>

3、X轴显示为文字的方法
<pre><code>series = [data for data in data_gen2('2016.03.15','2016.04.25',['北京二手笔记本'])]
print(series)
options = {
    'chart'   : {'zoomType':'xy'},
    'title'   : {'text': '二手笔记本电脑成色对应的平均价格'},
    'xAxis'   : {'categories': [i[0] for i in data_gen2('2016.03.15','2016.04.25',['北京二手笔记本'])]},
    'yAxis'   : {'title': {'text': '价格'}},
    
}
charts.plot(series, show='inline', options=options)</code></pre>

4、对于价格中出现None的需要处理，还要把价格的值转为int类型，否则无法算出平均值。  
5、在清理数据的之前，需要备份数据库

# 第四周 #
## 课前准备 ##
1、安装django
[http://study.163.com/course/courseLearn.htm?courseId=1002794001#/learn/text?lessonId=1003188006&courseId=1002794001](http://study.163.com/course/courseLearn.htm?courseId=1002794001#/learn/text?lessonId=1003188006&courseId=1002794001)
2、之后改动了文件，要提交到服务器上时,都要执行：
python manage.py runserver

## 第一节课程 ##

搭建简单网站：

第一步：理解MTV模型

MTV (与MVC类似) :  
models(托管数据，对数据存储，增删改查)   
templates（加载数据的网页）  
 views（视图，页面）

第二步：搭建简单的网站
 
- 新建app   
F:\python\learn\Django_sample>python manage.py startapp django_web

- 注意以下文件  
views.py ：负责取数据 找temp类  
models.py ：从数据库取数据  
templetes  ：文件夹里建html文件

- 在settings.py 中  添加app（比如django_web站点）
 <code><pre>INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
	'django_web'
]</code></pre>
